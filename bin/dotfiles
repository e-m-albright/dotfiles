#!/usr/bin/env bash

BIN_NAME=$(basename "$0")
COMMAND_NAME=$1

ARROW="ï¿«"
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m'

# Get dotfiles dir (so run this script from anywhere)
export DOTFILES_DIR EXTRA_DIR
DOTFILES_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && cd .. && pwd )"

sub_help () {
    printf "%s Usage: ${YELLOW}%s <command>${NC}\n" "$ARROW" "$BIN_NAME"
    printf "\n"
    printf "Commands:\n"
    printf "   help             This help message\n"
    printf "   update           Update packages and pkg managers (OS, brew, node, npm, yarn, commposer)\n"
    printf "   clean            Clean up caches (brew, npm, yarn, composer)\n"
    printf "   brew             Run brew script\n"
    printf "   dock             Run MacOS dock script\n"
}

sub_update () {
    sudo softwareupdate -i -a
    brew update
    brew upgrade
    
    # Update Node.js to latest LTS via fnm
    if command -v fnm >/dev/null 2>&1; then
        eval "$(fnm env)"
        fnm install --lts
        fnm use --install-if-missing lts-latest
        fnm default lts-latest
    fi
    
    printf "${GREEN}%s Success! Update command finished.${NC}\n" "$ARROW"
}

sub_clean () {
    brew cleanup
    printf "${GREEN}%s Success! Clean command finished.${NC}\n" "$ARROW"
}

sub_brew () {
    . "$DOTFILES_DIR/macos/brew.sh"
    printf "${GREEN}%s Success! Brew command finished.${NC}\n" "$ARROW"
}

sub_dock () {
    . "$DOTFILES_DIR/macos/dock.sh"
    printf "${GREEN}%s Success! MacOS dock command finished.${NC}\n" "$ARROW"
}

case $COMMAND_NAME in
    "" | "-h" | "--help")
        sub_help
        ;;
    *)
        shift
        sub_${COMMAND_NAME} $@
        if [ $? = 127 ]; then
            printf "${RED}%s Error: '%s' is not a known command or has errors.${NC}\n" "$ARROW" "$COMMAND_NAME" >&2
            sub_help
            exit 1
        fi
        ;;
esac